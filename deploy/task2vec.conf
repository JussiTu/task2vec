# Apache VirtualHost for task2vec.com
# Place in /etc/apache2/sites-available/task2vec.conf
# Enable with: sudo a2ensite task2vec && sudo systemctl reload apache2
#
# Prerequisites:
#   sudo a2enmod proxy proxy_http headers rewrite
#   sudo certbot --apache -d task2vec.com -d www.task2vec.com

<VirtualHost *:80>
    ServerName task2vec.com
    ServerAlias www.task2vec.com
    # Redirect all HTTP to HTTPS (certbot adds this automatically)
    Redirect permanent / https://task2vec.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName task2vec.com
    ServerAlias www.task2vec.com

    # Static files served directly from the project directory
    DocumentRoot /var/www/task2vec

    <Directory /var/www/task2vec>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        # Cache large assets (spring_explorer.html is ~16 MB)
        <FilesMatch "\.(html|js|css|json)$">
            Header set Cache-Control "max-age=3600, must-revalidate"
        </FilesMatch>
    </Directory>

    # Proxy /api/* to gunicorn running on port 5001
    ProxyPreserveHost On
    ProxyPass        /api/ http://127.0.0.1:5001/api/
    ProxyPassReverse /api/ http://127.0.0.1:5001/api/

    # CORS headers for the API (belt-and-suspenders; Flask also sets these)
    <Location /api/>
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type"
    </Location>

    # Let Apache handle OPTIONS pre-flight quickly
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^/api/ - [R=204,L]

    # SSL (filled in by certbot)
    # SSLCertificateFile    /etc/letsencrypt/live/task2vec.com/fullchain.pem
    # SSLCertificateKeyFile /etc/letsencrypt/live/task2vec.com/privkey.pem
    # Include /etc/letsencrypt/options-ssl-apache.conf

    ErrorLog  ${APACHE_LOG_DIR}/task2vec_error.log
    CustomLog ${APACHE_LOG_DIR}/task2vec_access.log combined
</VirtualHost>
